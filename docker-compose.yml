services:
  # Nginx Reverse Proxy - serves everything on port 80
  # Frontend at http://localhost/
  # MCP Servers at http://localhost/mcp/dabstep, http://localhost/mcp/synth, http://localhost/mcp/postgres
  nginx:
    image: nginx:alpine
    container_name: mcp-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - mcp-dabstep
      - mcp-synth
      - mcp-postgres
    restart: unless-stopped
    networks:
      - mcp-network

  # MCP Server - Dabstep Database Context
  mcp-dabstep:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-dabstep
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - MCP_NAME=dabstep
      - MCP_PORT=8000
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - mcp-network

  # MCP Server - Synth Database Context
  mcp-synth:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-synth
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - MCP_NAME=synth
      - MCP_PORT=8000
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - mcp-network

  # MCP Server - PostgreSQL Database (Supabase)
  # Read-only access to Supabase PostgreSQL via HTTP/SSE transport
  mcp-postgres:
    build:
      context: ./postgres-mcp
      dockerfile: Dockerfile
    container_name: mcp-postgres
    environment:
      - POSTGRES_HOST=${SUPABASE_SYNTHETIC_HOST}
      - POSTGRES_PORT=${SUPABASE_SYNTHETIC_PORT}
      - POSTGRES_USER=${SUPABASE_SYNTHETIC_USER}
      - POSTGRES_PASSWORD=${SUPABASE_SYNTHETIC_PASSWORD}
      - POSTGRES_DATABASE=${SUPABASE_SYNTHETIC_DATABASE}
      - MCP_PORT=8000
    restart: unless-stopped
    networks:
      - mcp-network

  # Web Frontend - UI for MCP interaction (internal only)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: mcp-frontend
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - SFTP_HOST=129.158.231.129
      - SFTP_PORT=4100
      - SFTP_USER=gauntlet
      - SFTP_PASSWORD=justsubmit
      - MCP_SERVER_URL=http://mcp-dabstep:8000
    volumes:
      - ./data:/app/data:ro
      - ./frontend/mcp_servers.json:/app/mcp_servers.json
    depends_on:
      - mcp-dabstep
    restart: unless-stopped
    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge
