version: "3.9"

services:
  # MCP Server - Database Context Server
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-server
    ports:
      - "${MCP_PORT:-8000}:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - mcp-network

  # Web Chatbot UI
  # Access via: http://localhost:3000
  chatbot-ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: chatbot-ui
    ports:
      - "${WEB_PORT:-3000}:3000"
    environment:
      - MCP_BASE_URL=http://mcp-server:8000
      - WEB_PORT=3000
      - FLASK_DEBUG=false
    volumes:
      - ./data:/app/data
    depends_on:
      - mcp-server
    restart: unless-stopped
    networks:
      - mcp-network
    command: python chatbot/web_app.py

  # SFTP Server for file management
  # Connect via: sftp -P 2222 datauser@localhost
  sftp-server:
    image: atmoz/sftp:alpine
    container_name: sftp-server
    ports:
      - "${SFTP_PORT:-2222}:22"
    volumes:
      - ./data:/home/${SFTP_USER:-datauser}/data
      - sftp-keys:/etc/ssh/keys
      - ./scripts/sftp-entrypoint.sh:/etc/sftp.d/fix-permissions.sh:ro
    command: "${SFTP_USER:-datauser}:${SFTP_PASSWORD:-changeme}:1001:1001:data"
    restart: unless-stopped
    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge

volumes:
  sftp-keys:
    name: company-mcp-sftp-keys
