flowchart TD
    %% User Interaction
    User([ğŸ‘¤ User]) -->|Types message| WebInterface[ğŸ“± Web Interface<br/>Flask App]

    %% Web Interface Processing
    WebInterface -->|POST /chat| ChatEndpoint[/chat Endpoint]
    ChatEndpoint --> A{AI Agent<br/>Available?}

    %% AI Agent Path
    A -->|Yes| SessionManager[ğŸ”„ Session Manager<br/>Get/Create Context]
    SessionManager --> AIAgent[ğŸ¤– AI Agent<br/>OpenRouter/Claude]
    AIAgent -->|Process with history| ToolDecision{ğŸ¤” Which MCP<br/>Tool?}

    %% MCP Tools
    ToolDecision -->|Data Questions| AnswerQuestion[ğŸ” answer_question<br/>Tool]
    ToolDecision -->|Schema Questions| SchemaTools[ğŸ“‹ Schema Tools<br/>list_databases,<br/>search_tables,<br/>get_table_schema]
    ToolDecision -->|List/Overview| ListTools[ğŸ“Š List Tools<br/>list_domains,<br/>list_tables]

    %% SQL Execution Path
    AnswerQuestion --> SqlService[ğŸ—„ï¸ SQL Service<br/>generate_and_execute_sql]
    SqlService -->|1. Generate SQL| SqlGenerator[ğŸ§  SQL Generator<br/>OpenRouter API<br/>GPT-4o-mini]
    SqlGenerator -->|2. Execute SQL| DatabaseLayer[ğŸ—ï¸ Database Layer]

    %% Database Connections
    DatabaseLayer -->|postgres_production| Postgres[(ğŸ˜ PostgreSQL<br/>Production)]
    DatabaseLayer -->|snowflake_production| Snowflake[(â„ï¸ Snowflake<br/>Production)]

    %% Schema/Metadata Path (No SQL execution)
    SchemaTools --> MCPServer[ğŸ“š MCP Server<br/>Database Context]
    ListTools --> MCPServer
    MCPServer -->|Load from JSON| DataFiles[ğŸ“ data/map/<br/>JSON files]

    %% Results Flow Back
    SqlService -->|Query Results| AIAgent
    MCPServer -->|Schema/Metadata| AIAgent
    AIAgent -->|Format Response| ContextUpdate[ğŸ’¾ Update<br/>Context]
    ContextUpdate --> Response[ğŸ“¤ Formatted<br/>Response]

    %% Fallback Path
    A -->|No| PatternMatcher[ğŸ” Pattern Matcher<br/>Rule-based Processing]
    PatternMatcher --> SqlService

    %% Final Response
    Response --> WebInterface
    PatternMatcher --> Response

    %% Styling
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef aiClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef dbClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef toolClass fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef responseClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px

    class User userClass
    class AIAgent,SqlGenerator aiClass
    class Postgres,Snowflake,DataFiles dbClass
    class AnswerQuestion,SchemaTools,ListTools,SqlService,MCPServer toolClass
    class Response responseClass

